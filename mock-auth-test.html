<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mock Authentication Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        input {
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 200px;
        }
        .current-users {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>üîß Mock Authentication System Test</h1>
    <p><strong>Instructions:</strong> This page tests the mock authentication system. Open your developer console to see OTP codes!</p>

    <div class="test-section">
        <h2>1. Registration Flow</h2>
        <div>
            <input type="email" id="regEmail" placeholder="Email (must include @dlsu.edu.ph)" value="test.student@students.dlsu.edu.ph">
            <input type="text" id="regName" placeholder="Full Name" value="Test Student">
            <input type="text" id="regProgram" placeholder="Program" value="BS Computer Science">
            <input type="text" id="regIdNumber" placeholder="ID Number" value="12112345">
            <br>
            <button onclick="testRegistration()">Register New User</button>
        </div>
        <div id="regResult"></div>
    </div>

    <div class="test-section">
        <h2>2. Email Status Check</h2>
        <div>
            <input type="email" id="statusEmail" placeholder="Email to check" value="test.student@students.dlsu.edu.ph">
            <button onclick="testEmailStatus()">Check Email Status</button>
        </div>
        <div id="statusResult"></div>
    </div>

    <div class="test-section">
        <h2>3. OTP Flow</h2>
        <div>
            <input type="email" id="otpEmail" placeholder="Email" value="test.student@students.dlsu.edu.ph">
            <button onclick="testSendOTP()">Send OTP</button>
            <br>
            <input type="text" id="otpCode" placeholder="OTP Code (check console)" maxlength="6">
            <button onclick="testVerifyOTP()">Verify OTP</button>
        </div>
        <div id="otpResult"></div>
    </div>

    <div class="test-section">
        <h2>4. Current Mock Users</h2>
        <div id="usersList" class="current-users"></div>
        <button onclick="loadUsers()">Refresh Users List</button>
    </div>

    <script>
        // Import the mock API (simulate module import)
        const API_BASE = 'mock://test';
        
        // Mock API functions
        async function mockRegister(user) {
            // Simulate the actual mock API logic
            await delay(500);
            
            if (!user.email || !user.email.includes('@dlsu.edu.ph')) {
                throw new Error("Please use a valid DLSU email address");
            }

            // Get existing users from localStorage
            const users = JSON.parse(localStorage.getItem('mockUsers') || '[]');
            
            // Check if user exists
            const existingUser = users.find(u => u.email.toLowerCase() === user.email.toLowerCase());
            if (existingUser) {
                throw new Error("User with this email already exists");
            }

            // Create new user
            const newUser = {
                id: `user-${Date.now()}`,
                ...user,
                isActive: true,
                isVerified: false,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            users.push(newUser);
            localStorage.setItem('mockUsers', JSON.stringify(users));

            return {
                token: `mock_jwt_token_${newUser.id}_${Date.now()}`,
                user: newUser
            };
        }

        async function mockEmailStatus(email) {
            await delay(300);
            const users = JSON.parse(localStorage.getItem('mockUsers') || '[]');
            const user = users.find(u => u.email.toLowerCase() === email.toLowerCase());
            
            return {
                existing_user: !!user,
                verified_user: user ? user.isVerified : false
            };
        }

        async function mockSendOTP(email) {
            await delay(500);
            const users = JSON.parse(localStorage.getItem('mockUsers') || '[]');
            const user = users.find(u => u.email.toLowerCase() === email.toLowerCase());
            
            if (!user) {
                throw new Error("User not found");
            }

            // Generate OTP
            const otp = Math.floor(100000 + Math.random() * 900000).toString();
            
            // Store OTP in localStorage
            const otpData = JSON.parse(localStorage.getItem('mockOTPs') || '{}');
            otpData[email.toLowerCase()] = {
                otp,
                expiresAt: Date.now() + 5 * 60 * 1000 // 5 minutes
            };
            localStorage.setItem('mockOTPs', JSON.stringify(otpData));

            console.log(`üîë OTP for ${email}: ${otp}`);
            
            return { email };
        }

        async function mockVerifyOTP(email, otp) {
            await delay(500);
            
            const users = JSON.parse(localStorage.getItem('mockUsers') || '[]');
            const user = users.find(u => u.email.toLowerCase() === email.toLowerCase());
            
            if (!user) {
                throw new Error("User not found");
            }

            // Check OTP
            const otpData = JSON.parse(localStorage.getItem('mockOTPs') || '{}');
            const stored = otpData[email.toLowerCase()];
            
            if (!stored) {
                throw new Error("No OTP found for this email");
            }

            if (Date.now() > stored.expiresAt) {
                delete otpData[email.toLowerCase()];
                localStorage.setItem('mockOTPs', JSON.stringify(otpData));
                throw new Error("OTP expired");
            }

            if (stored.otp !== otp) {
                throw new Error("Invalid OTP");
            }

            // OTP is valid, verify user
            const userIndex = users.findIndex(u => u.id === user.id);
            users[userIndex] = {
                ...users[userIndex],
                isVerified: true,
                lastLogin: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            localStorage.setItem('mockUsers', JSON.stringify(users));

            // Clean up OTP
            delete otpData[email.toLowerCase()];
            localStorage.setItem('mockOTPs', JSON.stringify(otpData));

            return {
                token: `mock_jwt_token_${user.id}_${Date.now()}`,
                user: users[userIndex]
            };
        }

        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="test-result ${type}">${message}</div>`;
        }

        async function testRegistration() {
            const email = document.getElementById('regEmail').value;
            const fullName = document.getElementById('regName').value;
            const currentProgram = document.getElementById('regProgram').value;
            const idNumber = document.getElementById('regIdNumber').value;

            try {
                const result = await mockRegister({
                    email,
                    fullName,
                    currentProgram,
                    idNumber,
                    phoneNumber: '+639123456789'
                });

                showResult('regResult', `‚úÖ Registration successful!<br>
                    User ID: ${result.user.id}<br>
                    Token: ${result.token.substring(0, 30)}...<br>
                    Verified: ${result.user.isVerified}`, 'success');
                
                loadUsers();
            } catch (error) {
                showResult('regResult', `‚ùå Registration failed: ${error.message}`, 'error');
            }
        }

        async function testEmailStatus() {
            const email = document.getElementById('statusEmail').value;

            try {
                const result = await mockEmailStatus(email);
                showResult('statusResult', `üìß Email Status:<br>
                    Existing User: ${result.existing_user}<br>
                    Verified: ${result.verified_user}`, 'info');
            } catch (error) {
                showResult('statusResult', `‚ùå Error: ${error.message}`, 'error');
            }
        }

        async function testSendOTP() {
            const email = document.getElementById('otpEmail').value;

            try {
                const result = await mockSendOTP(email);
                showResult('otpResult', `üì± OTP sent to ${result.email}!<br>
                    <strong>Check the browser console for the OTP code</strong>`, 'success');
            } catch (error) {
                showResult('otpResult', `‚ùå Send OTP failed: ${error.message}`, 'error');
            }
        }

        async function testVerifyOTP() {
            const email = document.getElementById('otpEmail').value;
            const otp = document.getElementById('otpCode').value;

            try {
                const result = await mockVerifyOTP(email, otp);
                showResult('otpResult', `‚úÖ OTP verification successful!<br>
                    User is now verified and logged in<br>
                    Token: ${result.token.substring(0, 30)}...`, 'success');
                
                loadUsers();
            } catch (error) {
                showResult('otpResult', `‚ùå OTP verification failed: ${error.message}`, 'error');
            }
        }

        function loadUsers() {
            const users = JSON.parse(localStorage.getItem('mockUsers') || '[]');
            const usersList = document.getElementById('usersList');
            
            if (users.length === 0) {
                usersList.innerHTML = '<p>No users registered yet.</p>';
                return;
            }

            let html = '<h4>Registered Users:</h4>';
            users.forEach((user, index) => {
                html += `
                    <div style="margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                        <strong>${user.fullName}</strong> (${user.email})<br>
                        <small>ID: ${user.id} | Verified: ${user.isVerified ? '‚úÖ' : '‚ùå'} | Created: ${new Date(user.createdAt).toLocaleString()}</small>
                    </div>
                `;
            });
            
            usersList.innerHTML = html;
        }

        // Load users on page load
        loadUsers();
    </script>
</body>
</html>